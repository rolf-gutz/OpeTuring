<title>Listar Produto</title>

{% extends "layout.html" %}

{% block rolf %}

	<div class="container" style="height: 85%; width: 100%;">
		<table id="dtBasicExample" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
			<thead>
			  <tr>
				<th class="th-sm">Nome do Produto</th>
				<th class="th-sm">Valor KG</th>
				<th class="th-sm">KG Disponiveis</th>
                <th class="th-sm">Selecionar KG</th>			
                <th class="th-sm">Adicionar</th>			
                <th class="th-sm">Remover</th>			
			  </tr>
			</thead>
			<tbody>
            {% for produto in produtos.items %}
			  <tr>
				<td nowrap="true">{{produto.nome}}</td>		
				<td nowrap="true"  id="valorProduto{{produto.idProduto}}">{{produto.valor}}</td>
				<td id="quantidadeRestante{{produto.idProduto}}" nowrap="true">{{produto.kg}}</td>
				<td nowrap="true">  
					<input class="valor"type="text" id="{{produto.idProduto}}" value="" placeholder="Adicione os quilos">
				</input>
				</td>
				<td>
					<button class="btn btn-info" role="button" onclick="addProduto('{{produto.idProduto}}')">
						Adicionar
					</button>
				</td>
				<td>
					<button class="btn btn-danger" role="button" onclick="removeProduto('{{produto.idProduto}}')">
						Remover
					</button>
				</td>
			  </tr>
			  {% endfor %}		  
			</tbody>
		</table>
		<div class="container  d-flex justify-content-center">
			<div class="row col-md-10" >
				<h3 id="somaProduto" >0.00</h3>
			</div>
			<div  >
				<button class="btn btn-info" role="button" onclick="enviarPedido()">
					Finalizar Pedido
				</button>

			</div>
		</div>
	</div>
	
	<div class="container  d-flex justify-content-center">
		<nav aria-label="...">
			<ul class="pagination">
			{% if not produtos.has_prev %}
				<li class="page-item  
			disabled" >
			{% endif %}
				<a class="page-link" href="./{{produtos.prev_num}}">Previous</a>
			</li>
	
			{% for page in produtos.iter_pages()%}
				<li class="page-item {% if page == produtos.page %} 
				active {% endif %}">
					<a class="page-link" href="./{{page}}" > {{page}}  <span
						class="sr-only">(current)</span></a>
				</li>
			{% endfor  %}
		
			{% if not produtos.has_next %}
				<li class="page-item disabled">
			{% endif %}
				<a class="page-link" href="./{{produtos.next_num}}">Next</a>
			</li>
			</ul>
		</nav>
	</div>


<script>
	document.listProdutos = []
	valorSoma = 0
	
	function addProduto(id) {
	var quantity = document.getElementById(id).value
	var valorProduto = document.getElementById('valorProduto'+id).innerText
	valorSoma += CalcularSubTotal(quantity,valorProduto)
    var result = document.listProdutos.find(x => x.idProduto === id)
    if (result === undefined) {
        document.listProdutos.push({idProduto: id, quantity: quantity , valorProduto: valorProduto})
    }
	var qtdDisponivel = document.getElementById('quantidadeRestante'+id).innerText

	var estoque = qtdDisponivel - quantity
	
	document.getElementById('quantidadeRestante'+id).innerText =  estoque
	document.getElementById('somaProduto').innerText = valorSoma
	
}

function CalcularSubTotal(valor, quantidade){
	var valorProduto = valor * quantidade
	return valorProduto
}
	
	
function removeProduto(id) {
	var quantity = document.getElementById(id).value
	var valorProduto = document.getElementById('valorProduto'+id).innerText
	valorSoma -= CalcularSubTotal(quantity,valorProduto)
    var result = document.listProdutos.find(x => x.idProduto === id)
    if (result.idProduto === id) {
        document.listProdutos.pop(result.idProduto)
    }

	

	document.getElementById('quantidadeRestante'+id).innerText = qtdDisponivel
	document.getElementById('somaProduto').innerText = valorSoma
}

function enviarPedido () {
	$.ajax({
    url: "/pedido/addPedido/",
    type: "POST",
    async: false,
    data: {
		lista : JSON.stringify(document.listProdutos),
    },
    success: function(response) {
      console.log("===== SUCCESS =====");
      console.log(response);
	  console.log(response.numeroPedido)
	  window.location = '/detalhesPedido/'+response.numeroPedido;
    },
    error: function(response) {
      console.log("===== ERROR =====");
      console.log(response);
    }
  });
}   


</script>	

	
{% endblock %}
